<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <style type="text/css">
            .content {
                text-align: center;
            }

            input.text {
                width: 320px;
            }
        </style>
        <title>Homework: JSON Exercise</title>
        <script>

            function generateHTML(jsonObj) {
                var html_text="<html><head><title>XML Parse Result</title></head><body>";
                html_text+="<table border='2'>";
                html_text+="<tbody>";

                // Table header
                html_text+="<tr>";        
                var headerArray = jsonObj.Mainline.Table.Header.Data;
                for (i=0; i<headerArray.length; i++) {
                    html_text+="<th>"+headerArray[i]+"</th>";
                }
                html_text+="</tr>";

                // Table body
                if ("Row" in jsonObj.Mainline.Table) {
                    var companies = jsonObj.Mainline.Table.Row;

                    for (i=0; i<companies.length; i++) {
                        html_text+="<tr>";
                        var company = companies[i];
                        html_text+="<td>"+company["Company"]+"</td>"; // Parent Company
                        html_text+="<td>"+company["Services"]+"</td>"; // Subsidiary Portfollo

                        // HQ/Info
                        var hubs = company["Hubs"]["Hub"];
                        html_text+="<td>";
                        if (0<hubs.length) {
                            html_text+="<ul>";
                            for (j=0; j<hubs.length; j++) {                    
                                html_text+="<li>"+((1>j)?("<b>"+hubs[j]+"</b>"):hubs[j])+"</li>";
                            }
                            html_text+="</ul>";                
                        }
                        html_text+="</td>";
                        
                        html_text+="<td>"+company["Revenue"]+"</td>"; // Annual Revenue
                        html_text+="<td><a href='"+company["HomePage"]+"'>"+company["HomePage"]+"</td>"; // HomePage
                        html_text+="<td><img src='"+company["Logo"]+"' width='100%'></td>"; // Logo
                        html_text+="</tr>";
                    }
                }
                
                html_text+="</tbody>";  html_text+="</table>";
                html_text+="</body></html>";  

                return html_text;
            }

            function viewJSON(url) {
                function loadJSON(url) {
                    var xhr;
                    if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
                        xhr = new XMLHttpRequest();
                    } else { // code for IE6, IE5
                        xhr = new ActiveXObject("Microsoft.XMLHTTP");
                    }            
                    
                    // Make full URL if the input value only have a file name.
                    // if (0 > url.indexOf("http")) {
                    //     url = "http://cs-server.usc.edu:45678/hw/hw4/"+url;
                    // }

                    xhr.open("GET", url, false);
                    try {
                        xhr.send();
                        if (404 == xhr.status && 4 == xhr.readyState) {
                            alert("The json file doesn't exist on the url.");
                            return "";
                        }
                    } catch (e) {                
                        if (e instanceof DOMException) {
                            if (0 == xhr.status && 4 == xhr.readyState) {
                                alert("Failed to load " + url + ": No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'null' is therefore not allowed access.");
                            } else {
                                console.log(e);
                                alert(e.message);
                            }
                            
                            return "";
                        }
                    }

                    return xhr.responseText;
                }

                var jsonDoc = loadJSON(url);
                if (0 < jsonDoc.length) {
                    try {        
                        var jsonObj = JSON.parse(jsonDoc);
                        var html_text = generateHTML(jsonObj);
                        hWin = window.open("", "Assignment4", "height=800,width=1200");
                        hWin.document.write(html_text);    
                    
                        hWin.document.close();
                    } catch (e) {
                        if (e instanceof SyntaxError) {
                            alert("Fail to parse JSON.");
                        }
                    }
                }
            }

        </script>
    </head>
    <body>
        <div class="content">
            <h1>Enter URL for Trucking List JSON File</h1>
            <form name="form1" method="POST" id="form1">
                <input class="text" type="text" name="URL" maxlength="255" size="100" value="truckinglist.json" />
                <br />
                <br />
                <input type="button" name="submit" value="Submit Query" onClick="viewJSON(URL.value)" />
            </form>
        </div>
    </body>
</html>
